name: CI/CD
env:
  CONT_NAME: "task"
  
on:
  push:
    branches: [ main ]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Build the Docker image
      run: docker build -t cr.yandex/${{ secrets.YCDOCKERID }}/${{ env.CONT_NAME }}:${{ github.sha }} .
    - name: Install yc cli
      run: curl -sSL https://{{ s3-storage-host }}{{ yc-install-path }} | bash
    - name: restart bash
      run: source /home/runner/.bashrc
    - name: yc auth
      run: yc config set token ${{ secrets.YCCLI }}
    - name: Push docker image
      run: yc container registry configure-docker; docker push cr.yandex/${{ secrets.YCDOCKERID }}/${{ env.CONT_NAME }}:${{ github.sha }}
    
